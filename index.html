<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 / 로그인</title>
</head>

<body>

    <h1>회원가입 및 로그인</h1>

    <!-- 회원가입 폼 -->
    <section id="register-section">
        <h2>회원가입</h2>
        <form id="register-form">
            <input type="text" id="register-username" placeholder="사용자 이름" required><br>
            <input type="password" id="register-password" placeholder="비밀번호" required><br>
            <select id="register-role" required>
                <option value="" disabled selected>역할을 선택하세요</option>
                <option value="멘토">멘토</option>
                <option value="멘티">멘티</option>
            </select><br>
            <button type="submit">회원가입</button>
        </form>
    </section>

    <br>

    <!-- 로그인 폼 -->
    <section id="login-section">
        <h2>로그인</h2>
        <form id="login-form">
            <input type="text" id="login-username" placeholder="사용자 이름" required><br>
            <input type="password" id="login-password" placeholder="비밀번호" required><br>
            <button type="submit">로그인</button>
        </form>
    </section>

    <!-- 로그인 상태 표시 -->
    <section id="status-section">
        <h3>로그인 상태</h3>
        <p id="status-message"></p>
        <button id="logout-button" style="display: none;">로그아웃</button>
    </section>

    <!-- 오류 메시지 출력 -->
    <div id="error-message" style="color: red;"></div>

    <script>
        // 페이지 로드 시 로그인 상태 확인
        window.onload = function () {
            const loggedInUser = localStorage.getItem('username');
            const statusMessage = document.getElementById('status-message');
            const logoutButton = document.getElementById('logout-button');
            
            if (loggedInUser) {
                statusMessage.innerText = `${loggedInUser}님, 로그인 상태입니다.`;
                logoutButton.style.display = 'inline-block';
            } else {
                statusMessage.innerText = '로그인하지 않았습니다.';
                logoutButton.style.display = 'none';
            }
        };

        // 회원가입 처리
        document.getElementById('register-form').addEventListener('submit', async function (event) {
            event.preventDefault();  // 폼 제출 기본 동작 방지

            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;

            try {
                const response = await fetch('https://swengserver2-production.up.railway.app/register', {  // Railway URL로 수정
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password, role })
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message);  // 성공 메시지 표시
                } else {
                    throw new Error(data.message);  // 오류 발생 시 예외 처리
                }
            } catch (error) {
                document.getElementById('error-message').innerText = `회원가입 실패: ${error.message}`;
            }
        });

        // 로그인 처리
        document.getElementById('login-form').addEventListener('submit', async function (event) {
            event.preventDefault();  // 폼 제출 기본 동작 방지

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch('https://swengserver2-production.up.railway.app/login', {  // Railway URL로 수정
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);  // 로그인 성공 메시지
                    // 로그인 성공 시 로컬 스토리지에 사용자 정보 저장
                    localStorage.setItem('username', username);
                    localStorage.setItem('role', data.role);  // 로그인한 사용자의 역할도 저장
                    // 상태 메시지 업데이트 및 로그인 상태로 변경
                    window.onload();
                } else {
                    throw new Error(data.message);  // 로그인 실패 시 오류 처리
                }
            } catch (error) {
                document.getElementById('error-message').innerText = `로그인 실패: ${error.message}`;
            }
        });

        // 로그아웃 처리
        document.getElementById('logout-button').addEventListener('click', function () {
            localStorage.removeItem('username');  // 로컬 스토리지에서 사용자 정보 삭제
            localStorage.removeItem('role');      // 역할 정보도 삭제
            window.onload();  // 로그인 상태 다시 확인
        });
    </script>

</body>

</html>
